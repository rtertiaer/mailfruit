---
# This play should occur before Postfix.
# TODO: handle multiple domains better
- name: Install opendkim
  ansible.builtin.apt:
    name:
    - opendkim
    - opendkim-tools
    state: present

- name: Manage /etc/opendkim/keys
  ansible.builtin.file:
    path: /etc/opendkim/keys
    state: directory
    owner: root
    group: opendkim
    mode: '0750'

# TODO: output pubkey; save this in a better spot to permit multiple domains
- name: Make opendkim key
  ansible.builtin.command: "opendkim-genkey -s mail -d {{ mailfruit_mail_domain }}"
  args:
    chdir: /etc/opendkim/keys
    creates: /etc/opendkim/keys/mail.private

- name: Set dkim key permissions
  ansible.builtin.file:
    path: /etc/opendkim/keys
    state: directory
    owner: root
    group: opendkim
    mode: '0750'
    recurse: yes

- name: Modify /etc/default/opendkim
  ansible.builtin.lineinfile:
    path: /etc/default/opendkim
    regexp: '^SOCKET='
    line: 'SOCKET="inet:12301@127.0.0.1"'

- name: Manage /etc/opendkim.conf
  ansible.builtin.template:
    src: opendkim.conf.j2
    dest: /etc/opendkim.conf
    owner: root
    group: root
    mode: '0755'
  notify:
    - Restart opendkim
